<Patch>

<!--Preparation-->

<!--Base adding empty anything if missing-->
    <!--This is important to avoid errors-->
    <Operation Class="PatchOperationSequence">
        <!-- <success>Always</success> -->
        <operations>
            <li Class="PatchOperationConditional">
                <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[not(thingDefs)]</xpath>
                <match Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[not(thingDefs)]</xpath>
                    <value>
                        <thingDefs>
                        </thingDefs>
                    </value>
                </match>
            </li>
            <li Class="PatchOperationConditional">
                <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[not(categories)]</xpath>
                <match Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[not(categories)]</xpath>
                    <value>
                        <categories>
                        </categories>
                    </value>
                </match>
            </li>
            <li Class="PatchOperationConditional">
                <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[not(disallowedCategories)]</xpath>
                <match Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[not(disallowedCategories)]</xpath>
                    <value>
                        <disallowedCategories>
                        </disallowedCategories>
                    </value>
                </match>
            </li>
            <li Class="PatchOperationConditional">
                <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[not(disallowedThingDefs)]</xpath>
                <match Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[not(disallowedThingDefs)]</xpath>
                    <value>
                        <disallowedThingDefs>
                        </disallowedThingDefs>
                    </value>
                </match>
            </li>
        </operations>
    </Operation>

<!--Adding dummy thingdefs to avoid errors if mods are missing-->
    <Operation Class="PatchOperationSequence">
        <operations>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Hard_Loose" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Hard_Loose</defName>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                        <li>Gold</li>
                                        <li>Silver</li>
                                        <li>Jade</li>
                                        <li>Pemmican</li>
                                    </thingDefs>
                                    <categories>
                                        <li>PlantMatter</li>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                    </ThingDef>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Heavy_Loose" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Heavy_Loose</defName>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                        <li>Gold</li>
                                        <li>Silver</li>
                                        <li>Jade</li>
                                    </thingDefs>
                                    <categories>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                    </ThingDef>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Paper" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Paper</defName>
                        <description>"a variety of books, tomes and publications"</description>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                    </thingDefs>
                                    <categories>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                    </ThingDef>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Soft_Loose" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Soft_Loose</defName>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                        <li>Pemmican</li>
                                        <li>Kibble</li>
                                    </thingDefs>
                                    <categories>
                                        <li>PlantMatter</li>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                    </ThingDef>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Small_Items" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Small_Items</defName>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                    </thingDefs>
                                    <categories>
                                        <li>Manufactured</li>
                                        <li>Foods</li>
                                        <li>PlantMatter</li>
                                        <li>Items</li>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                    </ThingDef>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Pallet" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Pallet</defName>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                    </thingDefs>
                                    <categories>
                                        <li>ResourcesRaw</li>
                                        <li>Textiles</li>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                        <li>PlantMatter</li>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                    </ThingDef>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Drinkable_Liquid" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Drinkable_Liquid</defName>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                        <li>Beer</li>
                                    </thingDefs>
                                    <categories>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                    </ThingDef>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Chemical" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Chemical</defName>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                        <li>Chemfuel</li>
                                    </thingDefs>
                                    <categories>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                    </ThingDef>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Armor" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Armor</defName>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                    </thingDefs>
                                    <categories>
                                        <li>ApparelArmor</li>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                    </ThingDef>
                </value>
            </li>
            <li Class="PatchOperationAdd">
                <xpath>/Defs</xpath>
                <value>
                    <ThingDef Name="RS_Dummy_Medieval_Weapon" ParentName="LWM_DeepStorage">
                        <defName>RS_Dummy_Medieval_Weapon</defName>
                        <building>
                            <fixedStorageSettings>
                                <filter>
                                    <thingDefs>
                                        <li>Weapons</li>
                                    </thingDefs>
                                    <categories>
                                    </categories>
                                    <disallowedThingDefs>
                                    </disallowedThingDefs>
                                    <disallowedCategories>
                                    </disallowedCategories>
                                </filter>
                            </fixedStorageSettings>
                        </building>
                        <researchPrerequisites>
                            <li>Smithing</li>
                        </researchPrerequisites>
                    </ThingDef>
                </value>
            </li>
        </operations>
    </Operation>

<!--Special Filters rules-->

<!--FertileFields-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Fertile Fields [1.1]</li>
        </mods>
        <match Class="PatchOperationSequence">
            <!-- <success>Always</success> -->
            <operations>
                <li Class="PatchOperationAdd">
                    <xpath>/Defs</xpath>
                    <value>
                        <ThingCategoryDef>
                            <defName>RS_FFResources</defName>
                            <label>Fertile Field's Resources</label>
                            <parent>ResourcesRaw</parent>
                        </ThingCategoryDef>
                    </value>
                </li>
                <li Class="PatchOperationReplace">
                    <xpath>/Defs/ThingDef[defName="RawCompost"
                        or defName="Fertilizer"
                        or defName="PileofDirt"
                        or defName="SandPile"
                        or defName="RFFClay"
                        or defName="RottedMush"
                        or defName="CrushedRocks"]/thingCategories</xpath>
                    <value>
                        <thingCategories>
                            <li>RS_FFResources</li>
                        </thingCategories>
                    </value>
                </li>
                <!--Quick check for ceramics-->
                <li Class="PatchOperationFindMod">
                    <mods>
                        <li>Ceramics</li>
                    </mods>
                    <nomatch Class="PatchOperationReplace">
                        <xpath>/Defs/ThingDef[defName="RFFClay"]/thingCategories</xpath>
                        <value>
                            <thingCategories>
                                <li>RS_FFResources</li>
                            </thingCategories>
                        </value>
                    </nomatch>
                </li>
            <!--Heavy Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]]
                        /categories[not(li="RS_FFResources")]</xpath>
                    <value>
                        <li>RS_FFResources</li>
                    </value>
                </li>
            <!--Hard Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]]
                        /categories[li="PlantMatter" and not(li="RS_FFResources")]</xpath>
                    <value>
                        <li>RS_FFResources</li>
                    </value>
                </li>
            <!--Soft Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[categories[li="PlantMatter" and not(li="RS_FFResources")]]
                        /thingDefs[li="Kibble" and li="Pemmican" and not(li="Gold")]</xpath>
                    <value>
                        <li>Fertilizer</li>
                        <li>PileofDirt</li>
                        <li>SandPile</li>
                        <li>CrushedRocks</li>
                    </value>
                </li>
                <!--Quick check for ceramics-->
                <li Class="PatchOperationFindMod">
                    <mods>
                        <li>Ceramics</li>
                    </mods>
                    <nomatch Class="PatchOperationAdd">
                        <xpath>/Defs/ThingDef/building/fixedStorageSettings
                            /filter[categories[li="PlantMatter" and not(li="RS_FFResources")]]
                            /thingDefs[li="Kibble" and li="Pemmican" and not(li="Gold")]</xpath>
                        <value>
                            <li>RFFClay</li>
                        </value>
                    </nomatch>
                </li>
            <!--Disallow pallets-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[categories[li="ResourcesRaw" and li="Textiles"]]
                        /disallowedCategories[li="PlantMatter"]</xpath>
                    <value>
                        <li>RS_FFResources</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--DZ + Dubs Bad Hygiene +/- FertileFields -->
    <!--This is a complex one, it follows the next logic:
    If Dubs Bad Hygiene, DocWorld and Fertile Fields are found, then add D9Ash and FecalSludge
    If Only Dubs Bad Hygiene and Docworld are found, then add FecalSludge and Biosolids
    If Only Dubs Bad Hygiene and Fertile Fields are found, then add FecalSludge, Biosolids and D9Ash
    If Only Dubs Bad Hygiene is found, then add FecalSludge And Biosolids
    If Only Fertile Fields is found, then add nothing-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Dubs Bad Hygiene</li>
        </mods>
        <match Class="PatchOperationFindMod">
            <mods>
                <li>DocWorld</li>
            </mods>
            <match Class="PatchOperationFindMod">
                <mods>
                    <li>Fertile Fields [1.1]</li>
                </mods>
                <match Class="PatchOperationSequence">
                <!--Add D9Ash and FecalSludge-->
                    <!-- <success>Always</success> -->
                    <operations>
                    <!--Heavy Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter/thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]</xpath>
                            <value>
                                <li>D9Ash</li>
                                <li>FecalSludge</li>
                            </value>
                        </li>
                    <!--Hard Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                                and categories[li="PlantMatter"]]/thingDefs</xpath>
                            <value>
                                <li>D9Ash</li>
                                <li>FecalSludge</li>
                            </value>
                        </li>
                    <!--Soft Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter[categories[li="PlantMatter"]]
                                /thingDefs[li="Kibble" and li="Pemmican" and not(li="Gold")]</xpath>
                            <value>
                                <li>D9Ash</li>
                            </value>
                        </li>
                    </operations>
                </match>
                <nomatch Class="PatchOperationSequence">
                <!--Add FecalSludge and Biosolids-->
                    <success>Always</success>
                    <operations>
                    <!--Heavy Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter/thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]</xpath>
                            <value>
                                <li>Biosolids</li>
                                <li>FecalSludge</li>
                            </value>
                        </li>
                    <!--Hard Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                                and categories[li="PlantMatter"]]/thingDefs</xpath>
                            <value>
                                <li>Biosolids</li>
                                <li>FecalSludge</li>
                            </value>
                        </li>
                    </operations>
                </nomatch>
            </match>
            <nomatch Class="PatchOperationFindMod">
                <mods>
                    <li>Fertile Fields [1.1]</li>
                </mods>
                <match Class="PatchOperationSequence">
                <!--Add D9Ash, FecalSludge and Biosolids-->
                    <success>Always</success>
                    <operations>
                    <!--Heavy Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter/thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]</xpath>
                            <value>
                                <li>D9Ash</li>
                                <li>Biosolids</li>
                                <li>FecalSludge</li>
                            </value>
                        </li>
                    <!--Hard Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                                and categories[li="PlantMatter"]]/thingDefs</xpath>
                            <value>
                                <li>D9Ash</li>
                                <li>Biosolids</li>
                                <li>FecalSludge</li>
                            </value>
                        </li>
                    <!--Soft Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter[categories[li="PlantMatter"]]
                                /thingDefs[li="Kibble" and li="Pemmican" and not(li="Gold")]</xpath>
                            <value>
                                <li>D9Ash</li>
                            </value>
                        </li>
                    </operations>
                </match>
                <nomatch Class="PatchOperationSequence">
                <!--Add FecalSludge and Biosolids-->
                    <success>Always</success>
                    <operations>
                    <!--Heavy Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter/thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]</xpath>
                            <value>
                                <li>Biosolids</li>
                                <li>FecalSludge</li>
                            </value>
                        </li>
                    <!--Hard Loose-->
                        <li Class="PatchOperationAdd">
                            <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                                and categories[li="PlantMatter"]]/thingDefs</xpath>
                            <value>
                                <li>Biosolids</li>
                                <li>FecalSludge</li>
                            </value>
                        </li>
                    </operations>
                </nomatch>
            </nomatch>
        </match>
    </Operation>

<!--Concrete for FertileFields-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Concrete for Fertile Fields</li>
        </mods>
        <match Class="PatchOperationSequence">
            <!-- <success>Always</success> -->
            <operations>
            <!--Heavy Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter/thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]</xpath>
                    <value>
                        <li>RFFCement</li>
                        <li>RFFConcrete</li>
                    </value>
                </li>
            <!--Hard Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                        and categories[li="PlantMatter"]]/thingDefs</xpath>
                    <value>
                        <li>RFFCement</li>
                        <li>RFFConcrete</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--PawnMorpher-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Pawnmorpher</li>
        </mods>
        <match Class="PatchOperationSequence">
            <!-- <success>Always</success> -->
            <operations>
            <!--Heavy Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter/thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]</xpath>
                    <value>
                        <li>Mutanite</li>
                    </value>
                </li>
            <!--Hard Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                        and categories[li="PlantMatter"]]/thingDefs</xpath>
                    <value>
                        <li>Mutanite</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Salted Meat-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Salted Meat</li>
        </mods>
        <match Class="PatchOperationSequence">
            <!-- <success>Always</success> -->
            <operations>
            <!--Hard Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                        and categories[li="PlantMatter"]]/thingDefs</xpath>
                    <value>
                        <li>VCE_Salt</li>
                    </value>
                </li>
            <!--Soft Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[categories[li="PlantMatter"]]
                        /thingDefs[li="Kibble" and li="Pemmican" and not(li="Gold")]</xpath>
                    <value>
                        <li>VCE_Salt</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Vanilla Brewing Expanded - Coffees and Teas-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Vanilla Brewing Expanded - Coffees and Teas</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Drinkable Liquid-->
                <li Class="PatchOperationConditional">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[thingDefs[li="Beer"]]/categories</xpath>
                    <match Class="PatchOperationAdd">
                        <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[thingDefs[li="Beer"]]/categories</xpath>
                        <value>
                            <li>VBE_DrinksNonAlcoholic</li>
                        </value>
                    </match>
                    <nomatch Class="PatchOperationAdd">
                        <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[thingDefs[li="Beer"]]</xpath>
                        <value>
                            <categories>
                                <li>VBE_DrinksNonAlcoholic</li>
                            </categories>
                        </value>
                    </nomatch>
                </li>
            </operations>
        </match>
    </Operation>

<!--Vanilla Brewing Expanded -->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Vanilla Brewing Expanded</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Drinkable Liquid-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[thingDefs[li="Beer"]]/categories</xpath>
                    <value>
                        <li>VBE_DrinksSimpleSpirits</li>
                        <li>VBE_DrinksLuxurySpirits</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Vanilla Factions Expanded - Medieval -->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Vanilla Factions Expanded - Medieval</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Drinkable Liquid-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter/thingDefs[li="Beer"]</xpath>
                    <value>
                        <li>VFEM_Wine</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Vanilla Factions Expanded - Vikings -->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Vanilla Factions Expanded - Vikings</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Drinkable Liquid-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter/thingDefs[li="Beer"]</xpath>
                    <value>
                        <li>VFEV_Mead</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Combat Extended-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Combat Extended</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Chemicals-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter/thingDefs[li="Chemfuel"]</xpath>
                    <value>
                        <li>FSX</li>
                        <li>Prometheum</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Rimefeller-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Rimefeller</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Chemicals-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter/thingDefs[li="Chemfuel"]</xpath>
                    <value>
                        <li>Napalm</li>
                        <li>OilBarrel</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Apparel Organizer (Continued)-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Apparel Organizer (Continued)</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Armor-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter/categories[li="ApparelArmor"]</xpath>
                    <value>
                        <li>Combat_Apparel</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Vanilla Expanded Framework-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Vanilla Expanded Framework</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Armor-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter/categories[li="ApparelArmor"]</xpath>
                    <value>
                        <li>VFEC_Shields</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Ceramics -->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Ceramics</li>
        </mods>
        <match Class="PatchOperationSequence">
            <!-- <success>Always</success> -->
            <operations>
            <!--If fertile fields is present, ignore sand-->
                <li Class="PatchOperationFindMod">
                    <mods>
                        <li>Fertile Fields [1.1]</li>
                    </mods>
                    <match Class="PatchOperationSequence">
                        <operations>
                        <!--Heavy Loose-->
                            <li Class="PatchOperationAdd">
                                <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                    /filter/thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]</xpath>
                                <value>
                                    <li>N7_RawClay</li>
                                </value>
                            </li>
                        <!--Hard Loose-->
                            <li Class="PatchOperationAdd">
                                <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                    /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                                    and categories[li="PlantMatter"]]/thingDefs</xpath>
                                <value>
                                    <li>N7_RawClay</li>
                                </value>
                            </li>
                        <!--Soft Loose-->
                            <li Class="PatchOperationAdd">
                                <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                    /filter[categories[li="PlantMatter" and not(li="RS_FFResources")]]
                                    /thingDefs[li="Kibble" and li="Pemmican" and not(li="Gold")]</xpath>
                                <value>
                                    <li>N7_RawClay</li>
                                </value>
                            </li>
                        <!--Disallow pallets-->
                            <li Class="PatchOperationAdd">
                                <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                    /filter[categories[li="ResourcesRaw" and li="Textiles"] and disallowedCategories[li="PlantMatter"]]/disallowedThingDefs</xpath>
                                <value>
                                    <li>N7_RawClay</li>
                                </value>
                            </li>
                        </operations>
                    </match>
                    <nomatch Class="PatchOperationSequence">
                        <operations>
                        <!--Heavy Loose-->
                            <li Class="PatchOperationAdd">
                                <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                    /filter/thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]</xpath>
                                <value>
                                    <li>N7_Sand</li>
                                    <li>N7_RawClay</li>
                                </value>
                            </li>
                        <!--Hard Loose-->
                            <li Class="PatchOperationAdd">
                                <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                    /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                                    and categories[li="PlantMatter"]]/thingDefs</xpath>
                                <value>
                                    <li>N7_Sand</li>
                                    <li>N7_RawClay</li>
                                </value>
                            </li>
                        <!--Soft Loose-->
                            <li Class="PatchOperationAdd">
                                <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                    /filter[categories[li="PlantMatter" and not(li="RS_FFResources")]]
                                    /thingDefs[li="Kibble" and li="Pemmican" and not(li="Gold")]</xpath>
                                <value>
                                    <li>N7_Sand</li>
                                    <li>N7_RawClay</li>
                                </value>
                            </li>
                        <!--Disallow pallets-->
                            <li Class="PatchOperationAdd">
                                <xpath>/Defs/ThingDef/building/fixedStorageSettings
                                    /filter[categories[li="ResourcesRaw" and li="Textiles"] and disallowedCategories[li="PlantMatter"]]/disallowedThingDefs</xpath>
                                <value>
                                    <li>N7_Sand</li>
                                    <li>N7_RawClay</li>
                                </value>
                            </li>
                        </operations>
                    </nomatch>
                </li>
            <!--Change thingCategories of Ceramics manufactured products-->
                <!--Big building blocks that are stony should go with other big blocks that are stony.-->
                <!--Same goes for metallic products-->
                <li Class="PatchOperationReplace">
                    <xpath>/Defs/ThingDef[defName="N7_HardenedCeramic"]/thingCategories</xpath>
                    <value>
                        <thingCategories Inherit="false">
                            <li>ResourcesRaw</li>
                        </thingCategories>
                    </value>
                </li>
                <li Class="PatchOperationReplace">
                    <xpath>/Defs/ThingDef[defName="N7_Porcelain"]/thingCategories</xpath>
                    <value>
                        <thingCategories Inherit="false">
                            <li>StoneBlocks</li>
                        </thingCategories>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Vanilla Books Expanded-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Vanilla Books Expanded</li>
        </mods>
        <match Class="PatchOperationSequence">
            <!-- <success>Always</success> -->
            <operations>
            <!--Paper-->
                <li Class="PatchOperationConditional">
                    <xpath>/Defs/ThingDef[contains(description, "a variety of books, tomes and publications")]/building/fixedStorageSettings/filter/categories</xpath>
                    <match Class="PatchOperationAdd">
                        <xpath>/Defs/ThingDef[contains(description, "a variety of books, tomes and publications")]/building/fixedStorageSettings/filter/categories</xpath>
                        <value>
                            <li>VBE_Books</li>
                        </value>
                    </match>
                </li>
            </operations>
        </match>
    </Operation>

<!--A Rimworld Of Magic-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>A RimWorld of Magic</li>
        </mods>
        <match Class="PatchOperationSequence">
            <!-- <success>Always</success> -->
            <operations>
            <!--Paper-->
                <li Class="PatchOperationConditional">
                    <xpath>/Defs/ThingDef[contains(description, "a variety of books, tomes and publications")]/building/fixedStorageSettings/filter/categories</xpath>
                    <match Class="PatchOperationAdd">
                        <xpath>/Defs/ThingDef[contains(description, "a variety of books, tomes and publications")]/building/fixedStorageSettings/filter/categories</xpath>
                        <value>
                            <li>TM_SkillBooks</li>
                            <li>TM_Scrolls</li>
                        </value>
                    </match>
                </li>
            <!--Hard Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]]
                        /categories[li="PlantMatter"]</xpath>
                    <value>
                        <li>TM_Magicyte</li>
                    </value>
                </li>
            <!--Small Items-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter/categories[li="Manufactured" and li="Foods" and li="PlantMatter" and li="Items"]</xpath>
                    <value>
                        <li>TM_Magicyte</li>
                    </value>
                </li>
            <!--Anything with RawResources, except pallet types-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[not(disallowedCategories[li="PlantMatter"])]/categories[li="ResourcesRaw"]</xpath>
                    <value>
                        <li>TM_Magicyte</li>
                    </value>
                </li>
            <!--Armor-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter/categories[li="ApparelArmor"]</xpath>
                    <value>
                        <li>TM_MagicEquipment</li>
                        <li>TM_MagicArtifacts</li>
                    </value>
                </li>
            <!--Drinkable Liquid-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter/thingDefs[li="Beer"]</xpath>
                    <value>
                        <li>ManaPotion</li>
                    </value>
                </li>
            <!--Anything that can hold plantmatter-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[categories[li="PlantMatter"]]/thingDefs</xpath>
                    <value>
                        <li>SeedofRegrowth</li>
                    </value>
                </li>
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings/filter[categories[li="ResourcesRaw"] and not(disallowedCategories[li="PlantMatter"])]/thingDefs</xpath>
                    <value>
                        <li>SeedofRegrowth</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Yayo's Combat 3-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Yayo's Combat 3</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Heavy Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]]
                        /categories</xpath>
                    <value>
                        <li>yy_ammo_category</li>
                    </value>
                </li>
            <!--Hard Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]]
                        /categories[li="PlantMatter"]</xpath>
                    <value>
                        <li>yy_ammo_category</li>
                    </value>
                </li>
            <!--Small Items-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter/categories[li="Manufactured" and li="Foods" and li="PlantMatter" and li="Items"]</xpath>
                    <value>
                        <li>yy_ammo_category</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Yayo's Combat 3 Adopted-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Yayo's Combat 3 [Adopted]</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Heavy Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]]
                        /categories</xpath>
                    <value>
                        <li>yy_ammo_category</li>
                    </value>
                </li>
            <!--Hard Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]]
                        /categories[li="PlantMatter"]</xpath>
                    <value>
                        <li>yy_ammo_category</li>
                    </value>
                </li>
            <!--Small Items-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter/categories[li="Manufactured" and li="Foods" and li="PlantMatter" and li="Items"]</xpath>
                    <value>
                        <li>yy_ammo_category</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--Combat Extended-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>Combat Extended</li>
        </mods>
        <match Class="PatchOperationSequence">
            <success>Always</success>
            <operations>
            <!--Heavy Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]]
                        /categories</xpath>
                    <value>
                        <li>Ammo</li>
                    </value>
                </li>
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and not(li="Pemmican")]]
                        /disallowedCategories</xpath>
                    <value>
                        <li>AmmoShells</li>
                        <li>AmmoMissiles</li>
                        <li>AmmoRockets</li>
                        <li>AmmoNeolithic</li>
                        <li>AmmoMedieval</li>
                    </value>
                </li>
            <!--Hard Loose-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]]
                        /categories[li="PlantMatter"]</xpath>
                    <value>
                        <li>Ammo</li>
                    </value>
                </li>
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[thingDefs[li="Gold" and li="Silver" and li="Jade" and li="Pemmican"]
                        and categories[li="PlantMatter"]]/disallowedCategories</xpath>
                    <value>
                        <li>AmmoShells</li>
                        <li>AmmoMissiles</li>
                        <li>AmmoRockets</li>
                        <li>AmmoNeolithic</li>
                        <li>AmmoMedieval</li>
                    </value>
                </li>
            <!--Small Items-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter/categories[li="Manufactured" and li="Foods" and li="PlantMatter" and li="Items"]</xpath>
                    <value>
                        <li>Ammo</li>
                    </value>
                </li>
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef/building/fixedStorageSettings
                        /filter[categories[li="Manufactured" and li="Foods" and li="PlantMatter" and li="Items"]]/disallowedCategories</xpath>
                    <value>
                        <li>AmmoShells</li>
                        <li>AmmoMissiles</li>
                        <li>AmmoRockets</li>
                        <li>AmmoNeolithic</li>
                        <li>AmmoMedieval</li>
                    </value>
                </li>
            <!--Disallow Ammo and Turrets for medieval weapons containers-->
                <li Class="PatchOperationAdd">
                    <xpath>/Defs/ThingDef[researchPrerequisites[li="Smithing"]]
                        /building/fixedStorageSettings/filter[categories[li="Weapons"]]
                        /disallowedCategories</xpath>
                    <value>
                        <li>Ammo</li>
                        <li>WeaponsTurrets</li>
                    </value>
                </li>
            </operations>
        </match>
    </Operation>

<!--DocWorld Original Patches-->
<!--https://github.com/DrZhivago1/DocWorld-->
    <Operation Class="PatchOperationFindMod">
        <mods>
            <li>DocWorld</li>
        </mods>
        <match Class="PatchOperationSequence">
            <operations>
            <!--Simple Chains: Lumber-->
                <li Class="PatchOperationFindMod">
                    <mods>
                        <li>Vanilla Furniture Expanded - Props and Decor</li>
                    </mods>
                    <match Class="PatchOperationFindMod">
                        <mods>
                            <li>Simple Chains: Lumber</li>
                        </mods>
                        <match Class="PatchOperationSequence">
                            <success>Always</success>
                            <operations>
                                <li Class="PatchOperationReplace">
                                    <xpath>/Defs/ThingDef[defName="DZ_VFEPD_WoodenLogs"]/costList</xpath>
                                    <value>
                                        <costList>
                                            <Owl_WoodLog>30</Owl_WoodLog>
                                        </costList>
                                    </value>
                                </li>
                                <li Class="PatchOperationReplace">
                                    <xpath>/Defs/ThingDef[defName="DZ_VFEPD_WoodenLogsLarge"]/costList</xpath>
                                    <value>
                                        <costList>
                                            <Owl_WoodLog>75</Owl_WoodLog>
                                        </costList>
                                    </value>
                                </li>
                                <li Class="PatchOperationReplace">
                                    <xpath>/Defs/ThingDef[defName="DZ_VFEPD_WoodenLogs" or defName="DZ_VFEPD_WoodenLogsLarge"]
                                        /building/fixedStorageSettings/filter/thingDefs</xpath>
                                    <value>
                                        <thingDefs>
                                            <li>Owl_WoodLog</li>
                                        </thingDefs>
                                    </value>
                                </li>
                            </operations>
                        </match>
                    </match>
                </li>
            </operations>
        </match>
    </Operation>

<!--Finishing-->

<!--Final check for bookshelves. If they are empty, then remove-->
    <Operation Class="PatchOperationRemove">
        <success>Always</success>
        <xpath>/Defs/ThingDef[contains(description, "a variety of books, tomes and publications") and building[fixedStorageSettings[filter[categories[not(*)]]]]]</xpath>
    </Operation>

<!--Deleting Dummy Defs-->
    <Operation Class="PatchOperationRemove">
        <xpath>/Defs/ThingDef[contains(defName, "RS_Dummy")]</xpath>
    </Operation>

</Patch>